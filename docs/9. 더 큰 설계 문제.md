# 9. 더 큰 설계 문제

- Profile 클래스와 SRP
- 새로운 클래스 추출
- 명령-질의 분리
- 단위 테스트의 유지 보수 비용
- 다른 설계에 관한 생각들
- 마치며

## 9.1 Profile 클래스와 SRP

- [책임1] Profile 클래스는 회사 혹은 인물 정보를 추적하고 관리한다.
- Profile 클래스가 포착하는 이러한 정보 집합들은 시간이 지나면서 많이 바뀔 수 있다.
  - 더 많은 정보가 추가되거나 몇 가지 정보는 제거 혹은 변경될 수 있다.
- [책임2] 조건의 집합이 프로파일과 매칭되는지 여부 혹은 그 정도를 알려 주는 점수를 계산하는 것이다.
- **SRP 위반!** : 클래스는 변경할 때 한 가지 이유만 있어야 한다. 클래스는 작고 단일 목적을 추구한다.

## 9.2 새로운 클래스 추출
- 책임 두 개를 정의하고 있는 Profile
  1. 프로파일에 관한 정보 추적하기
  2. 조건 집합이 프로파일에 매칭되는지 혹은 그 정도를 판단하기

- 매칭 책임(2번)에 관한 코드를 MatchSet 클래스로 추출해보기

```kotlin
// 프로파일에 관한 정보를 추적하는 Profile 클래스
import java.util.function.Predicate
import java.util.stream.Collectors

class Profile(val name: String) {
  private val answers = HashMap<String, Answer>()
  var score: Int = 0
    private set


  // 회사에게 받은 질문에 대한 답변을 저장
  fun add(answer: Answer) {
    answers[answer.questionText] = answer
  }

  fun matches(criteria: Criteria) : Boolean {
    val matchSet = MatchSet(answers, criteria)
    score = matchSet.score
    return matchSet.matches()
  }

  override fun toString(): String {
    return name
  }

  fun find(pred: Predicate<Answer>) : List<Answer> {
    return answers.values.stream()
      .filter(pred)
      .collect(Collectors.toList())
  }
}

// 매칭에 대한 책임을 담당하는 MatchSet 클래스
class MatchSet(private var answers: HashMap<String, Answer>, private var criteria: Criteria) {

  var score = 0
    private set

  init {
    calculateScore(criteria)
  }

  private fun calculateScore(criteria: Criteria) {
    for (criterion: Criterion in criteria) {
      if (criterion.matches(answerMatching(criterion)))
        score += criterion.weight.value
    }
  }

  private fun answerMatching(criterion: Criterion) = answers[criterion.answer.questionText]

  fun matches(): Boolean {
    if (doesNotMeetAnyMustMatchCriterion(criteria)) // 특정 조건에 걸리면 false
      return false
    return anyMatches(criteria) // 조건이 맞는 다른 경우를 찾기
  }

  private fun doesNotMeetAnyMustMatchCriterion(criteria: Criteria): Boolean {

    for (criterion: Criterion in criteria) {
      val match = criterion.matches(answerMatching(criterion))
      if (!match && criterion.weight == Weight.MustMatch) {
        return true
      }
    }
    return false
  }

  private fun anyMatches(criteria: Criteria) : Boolean {
    var anyMatches = false
    for (criterion: Criterion in criteria) {
      anyMatches = anyMatches or criterion.matches(answerMatching(criterion))
    }
    return anyMatches
  }
}

```

## 9.3 명령-질의 분리
- 어떤 값을 반환하고 부작용을 발생시키는 (시스템에 있는 어떤 클래스 혹은 엔터티의 상태 변경) 메서드는 명령-질의 분리 원칙을 위반한다.
- 어떤 메서드는 실행(부작용을 생성하는 어떤 작업을 함) 하거나 질의에 대답(어떤 값을 반환)할 수 있으며, 두 작업을 모두 하면 안 된다.

```kotlin
// 문제의 명령-질의 분리 원칙을 위배한 부분
fun matches(criteria: Criteria) : Boolean {
  val matchSet = MatchSet(answers, criteria)
  score = matchSet.score
  return matchSet.matches()
}
```

- score 필드를 Profile에서 제거
# 11. 테스트 리팩토링

- 이해 검색
- 테스트 냄새: 불필요한 테스트 코드
- 테스트 냄새: 추상화 누락
- 테스트 냄새: 부적절한 정보
- 테스트 냄새: 부푼 생성
- 테스트 냄새: 다수의 단언
- 테스트 냄새: 테스트와 무관한 세부 사항들
- 테스트 냄새: 잘못된 조직
- 테스트 냄새: 암시적 의미
- 새로운 테스트 추가
- 마치며

> 테스트는 결함을 최소화하고 리팩토링으로 프로덕션 시스템을 깔끔하게 유지시켜 주지만, 이것은 지속적인 비용을 의미한다.
> 
> 비용 증가로 이어지는 테스트 문제들을 해결해보자 

## 11.1 이해 검색
- 많이 복잡해보이는 Search 클래스의 테스트 코드
- 테스트가 무엇을 하는지 완전히 이해하려면 테스트를 매 행마다 꼼꼼하게 읽고 의미 조각들을 맞추어 보아야 한다.
- 리팩토링을 시작해보자...
- (**나는 역시 Kotlin 코드로 변환한 후부터 시작하고자 한다.**)

```kotlin
import org.hamcrest.CoreMatchers
import org.junit.Assert
import org.junit.Test
import java.io.ByteArrayInputStream
import java.net.URL
import java.util.logging.Level


class SearchTest {
    @Test
    fun testSearch() {
        try {
            val pageContent = ("There are certain queer times and occasions "
                    + "in this strange mixed affair we call life when a man "
                    + "takes this whole universe for a vast practical joke, "
                    + "though the wit thereof he but dimly discerns, and more "
                    + "than suspects that the joke is at nobody's expense but "
                    + "his own.")
            val bytes = pageContent.toByteArray()
            val stream = ByteArrayInputStream(bytes)
            // search
            var search = Search(stream, "practical joke", "1")
            Search.LOGGER.level = Level.OFF
            search.setSurroundingCharacterCount(10)
            search.execute()
            Assert.assertFalse(search.errored())
            val matches: List<Match> = search.getMatches()
            Assert.assertThat<List<Match>>(matches, CoreMatchers.`is`(CoreMatchers.notNullValue()))
            Assert.assertTrue(matches.size >= 1)
            val match: Match = matches[0]
            Assert.assertThat(match.searchString, CoreMatchers.equalTo("practical joke"))
            Assert.assertThat(match.surroundingContext,
                CoreMatchers.equalTo("or a vast practical joke, though t"))
            stream.close()

            // negative
            val connection = URL("http://bit.ly/15sYPA7").openConnection()
            val inputStream = connection.getInputStream()
            search = Search(inputStream, "smelt", "http://bit.ly/15sYPA7")
            search.execute()
            Assert.assertThat(search.getMatches().size, CoreMatchers.equalTo(0))
            stream.close()
        } catch (e: Exception) {
            e.printStackTrace()
            Assert.fail("exception thrown in test" + e.message)
        }
    }
}
```

## 11.2 테스트 냄새: 불필요한 코드
- 테스트 코드가 예외를 기대하지 않는다면 그냥 throw 해버리면 된다. (try-catch 지우자)
- not null assert는 유용한 정보를 담고 있지 않은 불필요한 테스트이다.

```kotlin
import org.hamcrest.CoreMatchers
import org.junit.Assert
import org.junit.Test
import java.io.ByteArrayInputStream
import java.io.IOException
import java.net.URL
import java.util.logging.Level
import kotlin.jvm.Throws


class SearchTest {
    @Test
    @Throws(IOException::class)
    fun testSearch() {
        val pageContent = ("There are certain queer times and occasions "
                + "in this strange mixed affair we call life when a man "
                + "takes this whole universe for a vast practical joke, "
                + "though the wit thereof he but dimly discerns, and more "
                + "than suspects that the joke is at nobody's expense but "
                + "his own.")
        val bytes = pageContent.toByteArray()
        val stream = ByteArrayInputStream(bytes)
        // search
        var search = Search(stream, "practical joke", "1")
        Search.LOGGER.level = Level.OFF
        search.setSurroundingCharacterCount(10)
        search.execute()
        Assert.assertFalse(search.errored())
        val matches: List<Match> = search.getMatches()
        Assert.assertTrue(matches.size >= 1)
        val match: Match = matches[0]
        Assert.assertThat(match.searchString, CoreMatchers.equalTo("practical joke"))
        Assert.assertThat(match.surroundingContext,
            CoreMatchers.equalTo("or a vast practical joke, though t"))
        stream.close()

        // negative
        val connection = URL("http://bit.ly/15sYPA7").openConnection()
        val inputStream = connection.getInputStream()
        search = Search(inputStream, "smelt", "http://bit.ly/15sYPA7")
        search.execute()
        Assert.assertThat(search.getMatches().size, CoreMatchers.equalTo(0))
        stream.close()
    }
}
```
